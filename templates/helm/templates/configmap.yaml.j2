{% raw %}apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "{% endraw %}{{ chart_name }}{% raw %}.fullname" . }}-oidc-config
  labels:
    {{- include "{% endraw %}{{ chart_name }}{% raw %}.labels" . | nindent 4 }}
data:
  oidc.yaml: |
    # FastMCP OAuth Proxy Configuration
    # Auto-generated from Helm values

    # ========================================================================
    # REQUIRED: OIDC Provider Configuration
    # ========================================================================

    # OIDC issuer URL (Auth0, Keycloak, Okta, Azure AD, etc.)
    issuer: {{ .Values.oidc.issuer | quote }}

    # API identifier (expected audience claim in tokens)
    audience: {{ .Values.oidc.audience | quote }}

    # OIDC application client ID
    client_id: {{ .Values.oidc.clientId | quote }}

    # Path to server client secret file (mounted from Kubernetes Secret)
    client_secret_file: '/etc/mcp/secrets/oidc/{{ .Values.oidc.clientSecretKey | default "server-client-secret" }}'

    # Path to JWT signing key file (mounted from Kubernetes Secret)
    jwt_signing_key_file: "/etc/mcp/secrets/jwt-signing-key"

    # Path to storage encryption key file (mounted from Kubernetes Secret)
    storage_encryption_key_file: "/etc/mcp/secrets/storage-encryption-key"

    # ========================================================================
    # REQUIRED: Server Configuration
    # ========================================================================

    {{- if and .Values.ingress.enabled .Values.ingress.host }}
    # Public URL of this MCP server
    public_url: {{ if .Values.ingress.tls.enabled }}"https://{{ .Values.ingress.host }}"{{ else }}"http://{{ .Values.ingress.host }}"{{ end }}
    {{- end }}

    # ========================================================================
    # OPTIONAL: Advanced Configuration
    # ========================================================================

    {{- if .Values.oidc.jwksUri }}
    jwks_uri: {{ .Values.oidc.jwksUri | quote }}
    {{- end }}

    {{- if .Values.oidc.scope }}
    scope: {{ .Values.oidc.scope | quote }}
    {{- end }}

    # ========================================================================
    # Redis Configuration (OAuth Session Persistence)
    # ========================================================================
    {{- if .Values.redis.enabled }}
    redis:
      host: "{{ .Release.Name }}-redis"
      port: {{ .Values.redis.service.port | default 6379 }}
      db: 0
    {{- end }}
{% endraw %}
