#!/usr/bin/env python3
"""
{{ server_name }} MCP Server - Entry Point

MCP server using FastMCP with {{ auth_type | default('auth0') }} authentication.
HTTP transport only (Streamable HTTP).

Tool implementations are in {{ server_name_snake }}_tools.py
"""

import argparse
import logging
import sys
import os
import warnings

# Suppress deprecation warnings from dependencies
warnings.filterwarnings("ignore", category=DeprecationWarning, module="urllib3")
warnings.filterwarnings("ignore", message=".*HTTPResponse.getheaders.*")

from fastmcp import FastMCP, Context
import uvicorn
from starlette.routing import Route
from starlette.responses import JSONResponse

# Import tool and resource registration from tools module
from {{ server_name_snake }}_tools import register_tools, register_resources

# Auth type: {{ auth_type | default('auth0') }}
AUTH_TYPE = "{{ auth_type | default('auth0') }}"

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(levelname)s:     %(message)s',
    handlers=[logging.StreamHandler(sys.stderr)]
)
logger = logging.getLogger(__name__)

# Suppress noisy loggers
logging.getLogger("httpx").setLevel(logging.WARNING)

# Custom filter to exclude health check endpoints from access logs
class HealthCheckFilter(logging.Filter):
    def filter(self, record: logging.LogRecord) -> bool:
        # Exclude health check paths from access logs
        return not any(path in record.getMessage() for path in ["/healthz", "/readyz", "/health"])

# ============================================================================
# FastMCP Server Initialization
# ============================================================================

mcp = FastMCP(
    "{{ server_name }}",
    instructions="""
{{ server_name }} MCP Server.

This server provides tools for managing {{ server_name_kebab }} resources
in Kubernetes environments.
"""
)

# ============================================================================
# Register Resources and Tools from tools module
# ============================================================================

register_resources(mcp)
register_tools(mcp)

logger.info("Resources and tools registered with MCP server")

# ============================================================================
# Health Check Endpoints
# ============================================================================

async def liveness_check(request):
    """Kubernetes liveness probe endpoint."""
    return JSONResponse({"status": "alive"})


async def readiness_check(request):
    """Kubernetes readiness probe endpoint."""
    return JSONResponse({"status": "ready"})


# ============================================================================
# HTTP Transport
# ============================================================================

def run_http_transport_auth0(host: str, port: int):
    """Run server in HTTP mode with FastMCP Auth0 OAuth Proxy."""
    from auth_fastmcp import create_auth0_oauth_proxy, get_auth_config_summary, load_oidc_config_from_file

    logger.info("Initializing FastMCP Auth0 OAuth Proxy...")

    # Load configuration
    config = load_oidc_config_from_file() or {}
    issuer = config.get("issuer") or os.getenv("OIDC_ISSUER") or ""
    audience = config.get("audience") or os.getenv("OIDC_AUDIENCE") or ""
    client_id = config.get("client_id") or os.getenv("AUTH0_CLIENT_ID") or ""
    public_url = config.get("public_url") or os.getenv("PUBLIC_URL") or ""

    # Create OAuth Proxy (handles token issuance)
    auth_proxy = create_auth0_oauth_proxy()

    # Log configuration summary
    config_summary = get_auth_config_summary(issuer, audience, client_id, public_url)
    logger.info("=" * 80)
    logger.info("FastMCP Auth0 OAuth Configuration:")
    logger.info("=" * 80)
    for key, value in config_summary.items():
        logger.info(f"  {key}: {value}")
    logger.info("=" * 80)

    # Set OAuth on mcp instance
    mcp.auth = auth_proxy

    # Create app with OAuth at /mcp endpoint
    app = mcp.http_app(transport="http", path="/mcp")

    # Add CORS middleware to handle OPTIONS preflight requests
    from starlette.middleware.cors import CORSMiddleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Allow all origins (customize as needed)
        allow_credentials=True,
        allow_methods=["GET", "POST", "OPTIONS"],  # Explicitly allow OPTIONS
        allow_headers=["*"],
    )

    # Add health check routes
    app.add_route("/healthz", liveness_check)
    app.add_route("/readyz", readiness_check)

    logger.info("")
    logger.info("=" * 80)
    logger.info("Server Configuration:")
    logger.info("=" * 80)
    logger.info(f"  Listening on: {host}:{port}")
    logger.info(f"  MCP Endpoint: /mcp")
    logger.info(f"  Auth Type: Auth0 (FastMCP OAuth Proxy)")
    logger.info("  Server: {{ server_name }}")
    logger.info(f"  OAuth Discovery: /.well-known/oauth-authorization-server")
    logger.info(f"  Client Registration: /register")
    logger.info("=" * 80)
    logger.info("")
    logger.info("To get an MCP token:")
    logger.info(f"  ./test/get-mcp-token.py --url http://{host}:{port}")
    logger.info("")
    logger.info("To test with MCP token:")
    logger.info("  ./test/test-mcp.py --transport http \\")
    logger.info(f"    --url http://{host}:{port}/mcp \\")
    logger.info("    --token-file /tmp/mcp-token.txt")
    logger.info("")

    # Add health check filter to uvicorn access logger
    logging.getLogger("uvicorn.access").addFilter(HealthCheckFilter())

    # Run server
    uvicorn.run(
        app,
        host=host,
        port=port,
        log_level="info",
        ws="none"
    )


def run_http_transport_oidc(host: str, port: int):
    """Run server in HTTP mode with generic OIDC authentication (Dex, Keycloak, etc.)."""
    from auth_oidc import OIDCAuthProvider, OIDCAuthMiddleware

    logger.info("Initializing Generic OIDC Authentication...")

    # Create OIDC auth provider (auto-discovers from issuer)
    auth_provider = OIDCAuthProvider()

    # Create app WITHOUT built-in auth (we'll add middleware)
    app = mcp.http_app(transport="http", path="/mcp")

    # Add CORS middleware to handle OPTIONS preflight requests
    from starlette.middleware.cors import CORSMiddleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Allow all origins (customize as needed)
        allow_credentials=True,
        allow_methods=["GET", "POST", "OPTIONS"],  # Explicitly allow OPTIONS
        allow_headers=["*"],
    )

    # Add OIDC authentication middleware
    app.add_middleware(
        OIDCAuthMiddleware,
        auth_provider=auth_provider,
        exclude_paths=["/healthz", "/readyz", "/.well-known/", "/register"]
    )

    # Add OAuth metadata routes
    for route in auth_provider.get_metadata_routes():
        app.add_route(route.path, route.endpoint, methods=route.methods)

    # Add health check routes
    app.add_route("/healthz", liveness_check)
    app.add_route("/readyz", readiness_check)

    logger.info("")
    logger.info("=" * 80)
    logger.info("Server Configuration:")
    logger.info("=" * 80)
    logger.info(f"  Listening on: {host}:{port}")
    logger.info(f"  MCP Endpoint: /mcp")
    logger.info(f"  Auth Type: Generic OIDC (Dex, Keycloak, etc.)")
    logger.info(f"  Issuer: {auth_provider.issuer}")
    logger.info(f"  Audience: {auth_provider.audience}")
    logger.info("  Server: {{ server_name }}")
    logger.info(f"  OAuth Discovery: /.well-known/oauth-authorization-server")
    if auth_provider.upstream_dcr_endpoint:
        logger.info(f"  Client Registration: /register (proxied)")
    logger.info("=" * 80)
    logger.info("")
    logger.info("To test with bearer token:")
    logger.info("  ./test/test-mcp.py --transport http \\")
    logger.info(f"    --url http://{host}:{port}/mcp \\")
    logger.info("    --token <your-jwt-token>")
    logger.info("")

    # Add health check filter to uvicorn access logger
    logging.getLogger("uvicorn.access").addFilter(HealthCheckFilter())

    # Run server
    uvicorn.run(
        app,
        host=host,
        port=port,
        log_level="info",
        ws="none"
    )


def run_http_transport(host: str, port: int):
    """Run server in HTTP mode with configured authentication."""
    if AUTH_TYPE == "oidc":
        run_http_transport_oidc(host, port)
    else:
        # Default to Auth0
        run_http_transport_auth0(host, port)


# ============================================================================
# Main Entry Point
# ============================================================================

def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description="{{ server_name }} MCP Server"
    )
    parser.add_argument(
        "--port",
        type=int,
        default=int(os.getenv("PORT", "{{ port }}")),
        help="Port for HTTP transport (default: {{ port }})"
    )
    parser.add_argument(
        "--host",
        default="0.0.0.0",
        help="Host for HTTP transport (default: 0.0.0.0)"
    )

    args = parser.parse_args()
    run_http_transport(args.host, args.port)


if __name__ == "__main__":
    main()
